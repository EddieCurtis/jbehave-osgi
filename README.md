#JBehave OGSi

JBehave OGSi was created to able to execute JBehave BDD like stories inside any OSGi environment. 
You can use it to test any kind of OSGi applications that requires to be executed inside a OSGi Container as an Eclipse RCP/SWT applications, OSGi Services, etc.
It can be used with:    
   - Tycho or Pax-Exam in a Maven building;
   - inside any IDE that provides a Junit OSGi environment as Eclipse PDE JUnit Plug-in Test;
   - Interactively inside any OSGi Container that uses Felix GoGo commands (for now only Equinox command is being provided);

It is composed by these components: 

- jbehave-osgi-bundles/org.jbehave.osgi.core, that wraps the JBehave Core API and exposes its functionalities; This is a required bundle on all cases.

- jbehave-osgi-bundles/org.jbehave.osgi.web, that wraps the JBehave Web API plus Selenium and its non-OSGi dependencies. It should be used when you need to run test for web applications.

- jbehave-osgi-bundles/org.jbehave.osgi.interactive that provides a way to interactively run stories in any OSGi container.

- jbehave-osgi-equinox, which supply Equinox specifics features, as the Felix GoGo based console command that works with JBehave OSGi Interactive.

* the minimum OSGI version needed is 4.3.

 
## Bulding JBehave for OSGi

The JBehave-OSGi components uses different approach to being built.
 
JBehave-OSGi Core, Interactive and Web are built using _Maven Bundle Plugin_, which uses _POM-first_ approach. 
This means that all information needed in the build is taken from the POM file and a OSGi manifest is generated by a the maven-bundle-plugin.

Equinox components are built using Eclipse Tycho, which uses a _MANIFEST-first_ approach. 
This mean that all information needed in the build is taken from the bundle manifest.

Its not possible to run both building methods together in the same Maven reactor (in the same running job), so you must to split the build into two phases.

### Get the sources

1) Clone the JBehave-OSGi git repository into your machine:

	git clone git://github.com/jbehave/jbehave-osgi.git


### First build the _POM-first_ projects:
 
2) Go to the root folder where you have cloned the project:

	cd /yourprojects/jbehave-osgi

3) Start the maven profile named **bundles**

	mvn clean install -P bundles
	
This will install the JBehave-OSGi Core, Interactive and Web bundles in your local maven repository.
	
	
### Then build the _MANIFEST-first_ projects:

4) Go to root folder where you have cloned the project

	cd /yourprojects/jbehave-osgi

5) Start the maven profile named **equinox**: 

	mvn clean verify -P equinox

This will create a P2 repository in the following folder: 

    /myprojects/jbehave-osgi/org.jbehave.osgi.equinox.repository/target/repository 
     
This P2 repository will contain all components and all bundles dependencies needed for JBehave-OSGi to be executed on Equinox.



## Setup Eclipse Development Environment for the JBehave-OSGi

In order to work with the code we recommend you to use Eclipse with M2e plug-in (plus Tycho extension) installed.

1) Create a new Eclipse workspace and name it jbehave-osgi

2) Import the projects (except the examples) using the _Maven Import_ into the new workspace. You should see compile errors due to the missing dependencies.

3) Setup the _Target Platform_ of the new workspace:

    - Go to /jbehave-osgi/jbehave-osgi-equinox/eclipse_targets folder and open the jbehave-osgi-kepler_local.target. 
      The eclipse will resolve its contents.
    - After Eclipse has been resolved the target definition file click in the _Set as Target Platform_ link. 
      Eclipse must resolve all compile errors.


  
## Working with the examples

We provided a series of OSGi projects to exemplify how you could use JBehave-OSGi. Each provided example has an Eclipse launcher file to easily start it.


### Setup Eclipse Development Environment for the provided Examples

In order to work with the examples we recommend you to use Eclipse with M2e plug-in (plus Tycho extension) installed.

1) Create a new Eclipse workspace and name it jbehave-osgi-examples

2) Import the examples projects using the _Maven Import_ into the new workspace. You should see compile errors due to the missing dependencies.

3) Setup the _Target Platform_ of the new workspace:

    - Go to /jbehave-osgi-examples/eclipse_targets folder and open the jbehave-osgi-examples-kepler_remote.target. 
      The eclipse will resolve its contents.
    - After Eclipse has been resolved the target definition file click in the _Set as Target Platform_ link. 
      Eclipse must resolve all compile errors.


### Running the test examples using PDE's Junit Plug-in

#### Trader Equinox Server Test Examples

1) Go to menu "Run", then "Run Configurations..."

2) Select TraderAnnotatedEmbedderRunnerOsgi or TraderAnnotatedPathRunnerOsgi launchers.

   
#### RCP Product Test with SWTBot Examples

1) Go to menu "Run", then "Run Configurations..."

2) Select RCPmailAnnotatedEmbedderRunner or RCPmailAnnotatedPathRunner launchers.


### Running the test examples using M2e/Maven with Tycho

#### Trader Equinox Server Test Example

1) Go to menu "Run", then "Run Configurations..."
2) Select build_jbehave-osgi_example_trader launcher.

   
#### RCP Product Test with SWTBot Example

1) Go to menu "Run", then "Run Configurations..."
2) Select build_jbehave-osgi_example_rcpmail launcher.


    
# JBehave-OSGi Interactive Services

Now you will be able execute your stories inside an OSGi container in an interactive way using the org.jbehave.osgi.interactive bundle.

What interactive means? 

It means that after you run your OSGi container and have installed the org.jbehave.osgi.interactive bundle, every time you install and activate a test bundle containing a JBehave-StoryRunner manifest header a StoryRunner service will be created for every AnnotatedPathRunner based Embedder specified.

This way you can use the provided GoGo commands in the console to interact with those StoryRunner services. For while we are providing a Equinox specific commands.

Take a look in the org.jbehave.osgi.examples.trader.it project manifest:

    Manifest-Version: 1.0
    Bundle-ManifestVersion: 2
    Bundle-Name: JBehave OSGi Trader IT Stories
    Bundle-SymbolicName: org.jbehave.osgi.examples.trader.it;singleton:=true
    Bundle-Version: 1.0.0.qualifier
    Bundle-Vendor: JBehave.org
    Bundle-RequiredExecutionEnvironment: JavaSE-1.6 
    Require-Bundle: org.junit,
     org.hamcrest.core;bundle-version="1.3.0",
     org.jbehave.osgi.core;bundle-version="1.0.0",
     org.hamcrest.integration;bundle-version="1.3.0",
     org.hamcrest.library;bundle-version="1.3.0"
    Import-Package: com.thoughtworks.paranamer;version="2.5.2",
     org.apache.commons.lang,
     org.apache.commons.lang.builder,
     org.jbehave.osgi.examples.trader.it.steps1,
     org.jbehave.osgi.examples.trader.it.steps1.converters,
     org.jbehave.osgi.examples.trader.it.steps2,
     org.jbehave.osgi.examples.trader.model,
     org.jbehave.osgi.examples.trader.persistence,
     org.jbehave.osgi.examples.trader.service
    Bundle-ActivationPolicy: lazy
    Export-Package: org.jbehave.osgi.examples.trader.it.converters,
     org.jbehave.osgi.examples.trader.it.embedder,
     org.jbehave.osgi.examples.trader.it.stories
    JBehave-StoryRunner: org.jbehave.osgi.examples.trader.it.embedder.*

The header JBehave-StoryRunner is telling to JBehave-OSGi Interactive Services that it must create a StoryRunner for any AnnotatedPathRunner based Embedder
in the org.jbehave.osgi.examples.trader.it.embedder package.

We provided an Eclipse launcher to exemplify its use. Let's see how to use it.


### Running the test examples using the Equinox Interactive Commands Locally


1) Go to menu "Run", then "Run Configurations..."
2) Select JBehave Interactive - local launcher.


2) After launching Equinox you can test JBehave OSGi Services with this command:

    osgi> help -scope jbehave
    
You should see the JBehave-OSGi Interactive help:

    storyRunner - Manage registered JBehave StoryRunner services.
       scope: jbehave
       flags:
          -d, --details   display StoryRunner services details
          -l, --list   list all registered services
          -r, --run   run stories
          -s, --stories   list associated stories
       parameters:
          StoryRunnerService[]   One or more registered StoryRunner services
	
3) List the StoryRunner services registered:

    osgi> storyrunner -l
    
you will see that only one StoryRunner service was registered:

    1) org.jbehave.osgi.examples.trader.it.embedder.TraderAnnotatedPathRunnerOsgi <org.jbehave.osgi.examples.trader.it>    


3) Run the StorieRunner service:

    osgi> storyrunner -r 1
    
    or
    
    osgi> storyrunner -r org.jbehave.osgi.examples.trader.it.embedder.TraderAnnotatedPathRunnerOsgi
    
     
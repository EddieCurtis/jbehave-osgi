#JBehave OGSi

JBehave OGSi was created to be able to execute JBehave stories inside an OSGi environment.

For now it can be used together with Tycho to test bundles deployed in an Eclipse Equinox container, RCP products using SWTBot deployed as bundles.

It is composed by 3 basic components: 

- jbehave-osgi-bundles/org.jbehave.osgi.core, that wraps the JBehave Core API and exposes its functionalities;
- jbehave-osgi-bundles/org.jbehave.osgi.web, that wraps the JBehave Web API and let it be used together with the JBehave-OSGi Core;
- jbehave-osgi-bundles/org.jbehave.osgi.interactive that provides a way to interactively run stories in any OSGi container.
- jbehave-osgi-equinox, which supply Equinox specifics features, as the Felix GoGo based console command that works with JBehave OSGi Interactive.


 
## Bulding JBehave for OSGi

1) Clone the JBehave-OSGi git repository into your machine:

	git clone git://github.com/jbehave/jbehave-osgi.git


* the minimum OSGI version needed is 4.3.

The JBehave-OSGi components uses different approach to being built.
 
JBehave-OSGi Core, Interactive and Web are built using Maven Bundle Plugin, which uses _POM-first_ approach. 
This means that all information needed in the build is taken from the POM file and a OSGi manifest is generated by a the maven-bundle-plugin.

Equinox components are built using Eclipse Tycho, which uses a _MANIFEST-first_ approach. This mean that all information needed in the build is taken from the bundle manifest.

Its not possible to run both building methods using the same maven reactor (in the same maven running job), so you must to split the build into two phases.


First build the _POM-first_ projects:
 
2) Go to the root folder where you have cloned the project:

	cd /yourprojects/jbehave-osgi

3) Start the maven profile named **bundles**

	mvn clean install -P bundles
	
This will install the JBehave-OSGi Core, Interactive and Web bundles in your local maven repository.
	
	
Then build the _MANIFEST-first_ projects:

4) Go to root folder where you have cloned the project

	cd /myprojects/jbehave-osgi

5) Start the maven profile *equinox*: 

	mvn clean verify -P equinox

This will create a P2 repository in the following folder: 

    /myprojects/jbehave-osgi/org.jbehave.osgi.equinox.repository/target/repository 
     
This P2 repository will contain all components and all bundles dependencies needed for JBehave-OSGi to be executed on Equinox.


## Setup Eclipse Development Environment

In order to work with the code we recommend you to use Eclipse with M2e and its Tycho plug-in installed.

1) Create a new Eclipse workspace and name it jbehave-osgi

2) Import the projects (except the examples) using the _Maven Import_ into the new workspace. You should see compile errors due to the missing dependencies.

3) Setup the _Target Platform_ of the new workspace:

    - Go to /jbehave-osgi/jbehave-osgi-equinox/eclipse_targets folder and open the jbehave-osgi-kepler_local.target. The eclipse will resolve it.
    - After Eclipse has been resolved the target definition file click in the _Set as Target Platform_ link. Eclipse must resolve all compile errors.


  
## Running the examples    
   
#### RCP Product Example

1) Go to root folder where you have cloned the project:

	cd /myprojects/jbehave-osgi
	
2) Start the maven build:

    mvn clean verify -P example-rcpmail
 
Now the build will start and the JBehave stories will be executed in the building.    
If everything goes right, you could see the generated RCP product in this folder:

	/myprojects/jbehave-osgi/jbehave-osgi-examples/rcpmail/org.jbehave.osgi.examples.rcpmail.product/target/products    


#### Trader Equinox Server Example

This example reuses code from Trader example, so you must to ensure that this project was properly built before.

1) Go to root folder where you have cloned the project:

	cd /myprojects/jbehave-osgi

2) You must to install the _POM-First_ projects:

    mvn clean install -P examples-pom-first

2) Then you need build the _MANIFEST-First_ projects:

    mvn clean verify -P example-manifest-first

    
### Using JBehave-OSGi for Equinox

When developing OSGi or RCP projects in Eclipse PDE, it's recommended that you create one workspace for each set of related projects, setting up one Target Platform for it, selecting only the necessary set of bundles that it needs to run the application and its tests properly.

You can run the BDD tests in a Equinox environment using three different ways: 

1) using Tycho-Surefire plugin as part of a Maven/Tycho building;
2) using a PDE's JUnit Plug-in Test launcher;
3) using JBehave OSGi commands at the console of some running Equinox container;

And to be able to use it you must add org.jbehave.osgi.services bundle to the Target Platform of your project or install it in some running container.


#### Setup JBehave-OSGi in a Target Platform


#### Installing JBehave-OSGi in a running Equinox container

 
 

#### Running Stories using an Equinox Launcher:

1) Setup OSGi Framework Launcher

Once your workspace/target platform is set up you can setup the Equinox launcher, choosing the bundles and tests fragments that must be installed when the Equinox is launched.  
We provided one launcher sample named run_jbehave-osgi_equinox_runtime where we selected org.jbehave.osgi.sample.fragment.trader.bnd test fragment.

- Go to menu "Run", then "Debug Configurations". 
- Select run_jbehave-osgi_equinox_runtime launcher.
- Check if only the necessary projects is selected on Workspace. 
- Ensure that all dependencies needed is selected on Target Platform clicking on "Validate Bundles". 
- If no problem were detected click on "Debug" button. That will start your Equinox instance with debug support (check the Console View).

2) After launching Equinox you can test JBehave OSGi Services with this commands:

    osgi> help
    
You should see the JBehave help (with others too):

	--- JBehave Equinox Commands ---
	jbStatus - JBehave OSGi EmbedderService status.
	jbRunStoriesWithAnnotatedEmbedder - Run Stories via Annotated Embedder. 
	
Then you could try the service status:

    osgi> jbStatus
    
You should see:

     OSGi Embedder Service is started.      

3) Run the stories via the Embedder

    osgi> jbRunStoriesWithAnnotatedEmbedder org.jbehave.osgi.examples.trader.annotations.TraderAnnotatedEmbedder
     